---
slug: "/docusaurus-algolia"
layout: Post
title: åˆ©ç”¨ Algolia å®ç°å†…å®¹æœç´¢ # åšå®¢æ ‡é¢˜ï¼ˆå¿…é¡»ï¼‰
date: 2023-01-24 # åšå®¢æ—¥æœŸï¼Œä¼šæ˜¾ç¤ºåœ¨æ–‡ç« å¤´éƒ¨ï¼ˆå¯é€‰ï¼‰
author: Lucas
author_title: ä¸€æšå°å‰ç«¯
author_url: https://github.com/ihoneys
author_image_url: /img/ihoneys.png
catalog: true # æ˜¯å¦å¯ç”¨å³ä¾§ç›®å½•ï¼šfalse / trueï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º falseï¼‰
tags: [Docker, Algolia]
---

Docusaurus é™æ€åšå®¢æ­å»ºä½¿ç”¨ algolia é…ç½®æœç´¢ã€‚

ç°åœ¨é™æ€åšå®¢çš„æ ‡é…ä¹‹ä¸€å°±æ˜¯åšå®¢æœç´¢ ğŸ”ï¼Œæˆ‘ä¹Ÿæ˜¯é€šè¿‡æ­å»ºåšå®¢å‘ç°äº†å®ƒï¼Œè¿™ç¯‡ä¸»è¦è®°å½•ä¸€ä¸‹æ€ä¹ˆä½¿ç”¨ `algolia` å®Œæˆåšå®¢æœç´¢ï¼Œè‡ªå·±çš„åšå®¢æ­å»ºä½¿ç”¨çš„æ˜¯ **[docusaurus](https://docusaurus.io/) ã€‚**

<!-- truncate -->

## æ³¨å†Œè´¦å·

é¦–å…ˆéœ€è¦å» [algolia](https://www.algolia.com/) å®˜ç½‘æ³¨å†Œè‡ªå·±çš„è´¦å·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Github æ³¨å†Œç™»é™†å³å¯ã€‚

æ³¨å†Œå®Œåï¼Œåˆ›å»ºæ•°æ®æº DBï¼š

![Untitled](img/01-24/img.png)

## åˆ›å»º Application

ç„¶åå°±æ˜¯åˆ›å»ºäº†ä½ è‡ªå·±çš„åº”ç”¨äº†ï¼š

![Untitled](img/01-24/img1.png)

![Untitled](img/01-24/img2.png)

åˆ›å»ºå®Œä¹‹åï¼Œéœ€è¦åˆ›å»ºå…³é”®çš„ index ç´¢å¼•äº†ï¼Œå®ƒç”¨æ¥å­˜æ”¾çˆ¬å–åˆ°çš„å†…å®¹æ•°æ®ã€‚ç‚¹å‡» `Indices`

![Untitled](img/01-24/img3.png)

å†ç»™ç´¢å¼•èµ·ä¸ªåå­—ï¼š**è¿™ä¸ªåå­—åé¢ä¼šç”¨åˆ°ï¼**

![Untitled](img/01-24/img4.png)

## Docusaurus é¡¹ç›®ä¸­é…ç½® algolia

Docusaurus å®˜æ–¹å·²ç»æ”¯æŒäº† algolia æœç´¢ï¼Œç›´æ¥å» `docusaurus.config.js` æ–‡ä»¶é…ç½®å³å¯ï¼š

```
themeConfig: {
		// ...
    algolia: {
      apiKey: "Search-Only API Key",
      indexName: "åˆšæ‰åˆ›å»ºç´¢å¼•çš„ nameï¼Œä¸æ˜¯æ•°æ®æºçš„ name",
      appId: "Application ID",
    },
}
```

å¦‚æœæ˜¯ç”¨å…¶ä»–æ­å»ºçš„æ¯”å¦‚ Hexoï¼ŒVuePress/ VitePresï¼Œä¹Ÿç±»ä¼¼ï¼Œåœ¨å¯¹åº”åœ¨ config æ–‡ä»¶é…ç½®å°±å¥½ã€‚

ä¸Šé¢ `apiKey`ã€`appId` å¯ä»¥åœ¨ **API Keys** é‡Œé¢æŸ¥çœ‹ï¼š

![Untitled](img/01-24/img5.png)

è¿è¡Œé¡¹ç›®ï¼Œå°±å¯ä»¥çœ‹åˆ°å‡ºç°æœç´¢åŠŸèƒ½ï¼Œè¿™æ—¶å€™è¿˜ä¸èƒ½ç”¨ï¼Œå› ä¸º algolia è¿˜æ²¡æœ‰çˆ¬å–è‡ªå·±ç½‘ç«™çš„å†…å®¹ã€‚

## Docker çˆ¬å–æœ¬åœ°å†…å®¹æ¨é€åˆ° **Algolia**

**ç”±äº Algolia é™åˆ¶å¼€æºé¡¹ç›®æ‰å¯ä»¥å…è´¹è¯•ç”¨çˆ¬è™«ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è‡ªå·±æ¨é€æ•°æ®ã€‚éœ€è¦å¦‚ä¸‹ç¯å¢ƒï¼š**

- [Docker](https://www.docker.com/)ï¼ˆæˆ‘çš„æ˜¯ mac ï¼Œä¸‹è½½å®‰è£…å³å¯ï¼‰
- jqï¼ˆ`brew install jq`ï¼‰â€”â€” è§£æ json æ–‡ä»¶ç”¨

çˆ¬å–ç¯å¢ƒåˆ›å»ºåï¼Œå®Œæˆä»¥ä¸‹æ­¥éª¤

1ã€ åˆ›å»º .env æ–‡ä»¶å­˜æ”¾ç¯å¢ƒå˜é‡

```makefile
ALGOLIA_APP_ID=xxx
ALGOLIA_API_KEY=xxx
```

2ã€åˆ›å»ºä¸€ä¸ª`docsearch.json`æ–‡ä»¶

```json
{
  // ä¿®æ”¹éƒ¨åˆ†
  "index_name": "å¯¹åº”ä¸Šconfigæ–‡ä»¶é‡Œé¢çš„indexNameï¼Œä¹Ÿæ˜¯åˆ›å»ºçš„ç´¢å¼•å",
  "start_urls": ["https://www.website.com/"], // è‡ªå·±çš„åŸŸåç½‘ç«™åœ°å€
  // æ›´æ¢è‡ªå·±çš„åŸŸååœ°å€ï¼ŒDocusaurus å®˜æ–¹ä¼šæœ‰é…ç½®ç”Ÿæˆ sitemap.xml çš„æ–¹å¼
  "sitemap_urls": ["https://www.website.com/sitemap.xml"],
  // end
  "stop_urls": ["/search"], // æ’é™¤ä¸éœ€è¦çˆ¬å–é¡µé¢çš„è·¯ç”±åœ°å€
  "selectors": {
    "lvl0": {
      "selector": "(//ul[contains(@class,'menu__list')]//a[contains(@class, 'menu__link menu__link--sublist menu__link--active')]/text() | //nav[contains(@class, 'navbar')]//a[contains(@class, 'navbar__link--active')]/text())[last()]",
      "type": "xpath",
      "global": true,
      "default_value": "Documentation"
    },
    "lvl1": "header h1, article h1",
    "lvl2": "article h2",
    "lvl3": "article h3",
    "lvl4": "article h4",
    "lvl5": "article h5, article td:first-child",
    "lvl6": "article h6",
    "text": "article p, article li, article td:last-child"
  },
  "custom_settings": {
    "attributesForFaceting": [
      "type",
      "lang",
      "language",
      "version",
      "docusaurus_tag"
    ],
    "attributesToRetrieve": [
      "hierarchy",
      "content",
      "anchor",
      "url",
      "url_without_anchor",
      "type"
    ],
    "attributesToHighlight": ["hierarchy", "content"],
    "attributesToSnippet": ["content:10"],
    "camelCaseAttributes": ["hierarchy", "content"],
    "searchableAttributes": [
      "unordered(hierarchy.lvl0)",
      "unordered(hierarchy.lvl1)",
      "unordered(hierarchy.lvl2)",
      "unordered(hierarchy.lvl3)",
      "unordered(hierarchy.lvl4)",
      "unordered(hierarchy.lvl5)",
      "unordered(hierarchy.lvl6)",
      "content"
    ],
    "distinct": true,
    "attributeForDistinct": "url",
    "customRanking": [
      "desc(weight.pageRank)",
      "desc(weight.level)",
      "asc(weight.position)"
    ],
    "ranking": [
      "words",
      "filters",
      "typo",
      "attribute",
      "proximity",
      "exact",
      "custom"
    ],
    "highlightPreTag": "<span class='algolia-docsearch-suggestion--highlight'>",
    "highlightPostTag": "</span>",
    "minWordSizefor1Typo": 3,
    "minWordSizefor2Typos": 7,
    "allowTyposOnNumericTokens": false,
    "minProximity": 1,
    "ignorePlurals": true,
    "advancedSyntax": true,
    "attributeCriteriaComputedByMinProximity": true,
    "removeWordsIfNoResults": "allOptional",
    "separatorsToIndex": "_",
    "synonyms": [
      ["js", "javascript"],
      ["ts", "typescript"]
    ]
  }
}
```

æ§åˆ¶å°æ‰§è¡Œ docker çˆ¬å»æ¨é€å‘½ä»¤ï¼š

```bash
docker run -it --env-file=.env -e "CONFIG=$(cat docsearch.json | jq -r tostring)" algolia/docsearch-scraper
```

éœ€è¦æå‰æ‰“å¼€ä¸‹è½½å¥½çš„ docker åº”ç”¨ã€‚

æ¥ä¸‹æ¥å°±æ˜¯ç­‰å¾…é˜¶æ®µï¼Œè¿™é‡Œéœ€è¦ç‚¹æ—¶é—´ download docker å†…ç½®çš„ä¸œè¥¿ã€‚

æœ€åæ§åˆ¶å°å‡ºç°ï¼š

![Untitled](img/01-24/img6.png)

è¯´æ˜å°±åœ¨æ¨é€æœ¬åœ°çˆ¬å–çš„å†…å®¹åˆ° algolia äº†ã€‚

## åˆ©ç”¨ Github Action

å¯ä»¥åˆ©ç”¨ github çš„ Action å¸®æˆ‘ä»¬è·‘è¿™ä¸ªé˜¶æ®µçš„å†…å®¹ï¼Œè¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚

é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.github/workflows/docsearch.yml` æ–‡ä»¶

å†…å®¹ï¼š

```yaml
name: docsearch

on:
  push:
    branches:
      - master
jobs:
  algolia:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get the content of docsearch.json as config
        id: algolia_config
        run: echo "::set-output name=config::$(cat docsearch.json | jq -r tostring)"

      - name: Run algolia/docsearch-scraper image
        env:
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
          CONFIG: ${{ steps.algolia_config.outputs.config }}
        run: |
          docker run \
            --env APPLICATION_ID=${ALGOLIA_APP_ID} \
            --env API_KEY=${ALGOLIA_API_KEY} \
            --env "CONFIG=${CONFIG}" \
            algolia/docsearch-scraper
```

è¿™é‡Œè¯´ä¸€ä¸‹è®¾ç½® github action è§¦å‘çš„æ¡ä»¶

- è¿™ä¸ªæ˜¯ push åˆ° master åˆ†æ”¯æ—¶è§¦å‘ã€‚

```yaml
on:
  push:
    branches:
      - master
```

- å‘å¸ƒæˆåŠŸåè§¦å‘

```yaml
on: deployment
```

- å®šæ—¶è§¦å‘

```yaml
on:
  schedule:
    # çº¦æ¯å¤©æ—©ä¸Š8ç‚¹è§¦å‘ï¼ˆUTCæ—¶é—´0ç‚¹ï¼‰
    - cron: "0 0 * * *"
```

- æ‰‹åŠ¨è§¦å‘

```yaml
on:
  workflow_dispatch:
```

æˆ‘ç”¨çš„æ˜¯ç¬¬ä¸€ç§ï¼Œæäº¤ä»£ç æ›´æ–°æ–‡ä»¶å°±è§¦å‘ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå…è´¹çš„åˆ›å»ºçš„ algolia é™åˆ¶æ–‡ä»¶ records 1000ï¼Œå¦‚æœè¶…è¿‡çš„è¯ï¼ŒGithub Action ä¼šè·‘å¤±è´¥ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯çˆ¬å–æ¨é€ä¸æˆåŠŸã€‚å¯¼è‡´æœç´¢ç”¨ä¸äº†ã€‚æš‚æ—¶è¿˜ä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼Œæ‰€ä»¥æˆ‘éƒ½æ˜¯æœ¬åœ°ç”¨ docker çš„ã€‚

## ç”¨èµ·æ¥äº†

æ ¹æ®ä¸Šé¢æ­¥éª¤å°±å¯ä»¥å®Œæˆ algolia çš„æœç´¢é…ç½®åŠŸèƒ½ã€‚
